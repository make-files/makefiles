#!/usr/bin/env bash
set -euo pipefail

PROTOC_ROOT="${1}"
shift

case "$(uname -s)" in
    "Darwin")
        OS="osx";;
    "Linux")
        OS="linux";;
    *)
        OS="linux";;
esac

ARCH="$(uname -m)"

if [[ "$OS" == "osx" && "$ARCH" == "arm64" ]]; then
    ARCH="aarch_64"
fi

if [[ "$OS" == "linux" && "$ARCH" == "aarch64" ]]; then
    ARCH="aarch_64"
fi

VERSION="$(curl --head --silent https://github.com/protocolbuffers/protobuf/releases/latest | grep -i '^Location:' | egrep -o '[0-9]+.[0-9]+')"

if [[ -f "${PROTOC_ROOT}/bin/protoc" ]]; then
    LOCAL_VERSION="$(${PROTOC_ROOT}/bin/protoc --version | sed -e 's/.* //')"
    [[ "${VERSION}" == "${LOCAL_VERSION}" ]] && exit 0
fi

ARCHIVE="protoc-${VERSION}-${OS}-${ARCH}.zip"
URL="https://github.com/protocolbuffers/protobuf/releases/download/v${VERSION}/${ARCHIVE}"

mkdir -p "${PROTOC_ROOT}"
pushd "${PROTOC_ROOT}"
curl --fail --silent --show-error --location --output "${ARCHIVE}" "${URL}"
unzip -o "${ARCHIVE}"
if [[ ! -x bin/protoc ]]; then ## if bin/protoc already executable, skip chmod, see PR#107.
    chmod +x bin/protoc
fi
find include/google -type d -exec chmod 755 {} \;
find include/google -type f -exec chmod 644 {} \;
popd
